---
description: "Reparaturbonus code quality - Next.js 15 + Prisma patterns"
alwaysApply: true
---

# Code Quality Rules

## Architecture

Next.js 15 App Router with Prisma:
- `src/app/` - Pages and API routes
- `src/components/` - React components
- `src/lib/` - Utilities, Prisma client
- `prisma/` - Database schema

## Core Principles

### 1. DRY - Don't Repeat Yourself
- Centralize Prisma client in `src/lib/prisma.ts`
- Reuse auth checks with middleware
- Extract bonus calculations to utilities

### 2. SSOT - Single Source of Truth
| Data | Location |
|------|----------|
| Database Schema | `prisma/schema.prisma` |
| Types | Generated from Prisma |
| Auth Config | `src/lib/auth.ts` |
| Constants | `src/lib/constants.ts` |

### 3. Security First
- Always validate input
- Check authentication on protected routes
- Never expose passwords in responses

## TypeScript Standards

```typescript
// Use Prisma-generated types
import { Shop, BonusCode, User } from '@prisma/client';

// Explicit return types
async function getActiveShops(): Promise<Shop[]> {
  return prisma.shop.findMany({
    where: { isVerified: true },
  });
}
```

## API Route Pattern

```typescript
import { getServerSession } from 'next-auth';
import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

export async function POST(request: Request) {
  // 1. Auth check
  const session = await getServerSession(authOptions);
  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // 2. Validate input
  const body = await request.json();
  if (!body.name) {
    return NextResponse.json({ error: 'Name required' }, { status: 400 });
  }

  // 3. Database operation
  const result = await prisma.shop.create({ data: body });
  
  // 4. Return response
  return NextResponse.json(result, { status: 201 });
}
```

## Don't

- Skip auth checks on protected routes
- Use raw SQL (use Prisma)
- Hardcode CHF amounts
- Return passwords in responses
